name: Deploy Hangman Bot to DigitalOcean

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Sync files to DigitalOcean droplet
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
        run: |
          echo "Syncing project files to server..."
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='.env' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ "$SSH_USER@$SSH_HOST:$PROJECT_DIR"

      - name: Deploy hangman bot container
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          echo "Building and deploying hangman bot..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << EOF
            cd $PROJECT_DIR

            # Enable Docker BuildKit for better caching
            export DOCKER_BUILDKIT=1

            # Build new image using previous image as cache
            # This will reuse layers that haven't changed
            docker build \
              --cache-from hangman-bot:latest \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              -t hangman-bot:latest .

            # Stop and remove old container if exists
            docker stop hangman-bot 2>/dev/null || true
            docker rm hangman-bot 2>/dev/null || true

            # Run new container with BOT_TOKEN from GitHub secrets
            docker run -d \
              --name hangman-bot \
              --restart unless-stopped \
              -p 8080:8080 \
              -e BOT_TOKEN="$BOT_TOKEN" \
              hangman-bot:latest

            # Clean up dangling images only (keep tagged images for cache)
            docker image prune -f

            # Show container status
            echo "Deployment complete!"
            docker ps --filter "name=hangman-bot"
          EOF
